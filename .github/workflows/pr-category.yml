name: PR Category Label

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  category:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Ensure category label matches PR title
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title || '';

            const match = title.match(/^([a-zA-Z]+)(?:\([^)]*\))?:/);
            if (!match) {
              core.setFailed('Unable to infer category. Please use a semantic PR title like `feat(ui): add button`.');
              return;
            }

            const category = match[1].toLowerCase();
            const labelName = `category/${category}`;

            async function ensureLabel() {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: labelName,
                });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelName,
                    color: '5319e7',
                    description: `Category inferred from PR title (${category})`,
                  });
                } else {
                  throw error;
                }
              }
            }

            const { data: existing } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });

            const labels = existing
              .map((label) => label.name)
              .filter((name) => !name.startsWith('category/'));
            labels.push(labelName);

            await ensureLabel();
            await github.rest.issues.setLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels,
            });

            core.info(`Applied ${labelName} based on PR title.`);
