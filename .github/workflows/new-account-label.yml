name: New Contributor Label

on:
  pull_request_target:
    types: [opened]

jobs:
  label-new-account:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Detect account age
        id: detect
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const userLogin = pr.user.login;

            const { data: user } = await github.rest.users.getByUsername({
              username: userLogin,
            });

            const createdAt = new Date(user.created_at);
            const now = new Date();
            const ageDays = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));

            core.setOutput('ageDays', ageDays.toString());
            core.setOutput('userLogin', userLogin);

            core.info(`User ${userLogin} account age: ${ageDays} days`);

      - name: Ensure label exists
        if: steps.detect.outputs.ageDays != '' && steps.detect.outputs.ageDays | int < 30
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const labelName = 'new-account';
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelName,
              });
            } catch (error) {
              if (error.status === 404) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: labelName,
                  color: 'bfe5bf',
                  description: 'PR author has a GitHub account younger than 30 days',
                });
              } else {
                throw error;
              }
            }

      - name: Apply label
        if: steps.detect.outputs.ageDays != '' && steps.detect.outputs.ageDays | int < 30
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const labelName = 'new-account';
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [labelName],
            });
