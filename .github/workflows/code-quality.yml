name: Code Quality Report

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quality:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: cargo fmt --check
        id: fmt
        continue-on-error: true
        run: cargo fmt --all -- --check

      - name: cargo clippy
        id: clippy
        continue-on-error: true
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: cargo test
        id: tests
        continue-on-error: true
        run: cargo test --all --all-features -- --nocapture

      - name: Post code quality summary
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: code-quality
          number: ${{ github.event.pull_request.number }}
          message: |
            ### Code Quality Report ðŸ§¼
            | Check | Status |
            | --- | --- |
            | `cargo fmt` | ${{ steps.fmt.outcome == 'success' && ':white_check_mark:' || ':x:' }} |
            | `cargo clippy` | ${{ steps.clippy.outcome == 'success' && ':white_check_mark:' || ':x:' }} |
            | `cargo test` | ${{ steps.tests.outcome == 'success' && ':white_check_mark:' || ':x:' }} |

            Result: **${{ job.status == 'success' && 'All clean âœ¨' || 'Needs attention ðŸ˜¿' }}**

      - name: Fail if any check failed
        if: ${{ steps.fmt.outcome != 'success' || steps.clippy.outcome != 'success' || steps.tests.outcome != 'success' }}
        run: |
          echo "::error ::Code quality checks failed."
          exit 1
